<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ‰‹æœºæˆªå›¾æ‰¹é‡æ‰“å°</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text x=%2250%22 y=%22.9em%22 font-size=%2285%22 text-anchor=%22middle%22>ğŸ–¼ï¸</text></svg>">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* ========== CSSå˜é‡å®šä¹‰ ========== */
        :root {
            /* èƒŒæ™¯åŠ¨ç”» */
            --animation-bg-speed: 20s;
            
            /* é¢œè‰²å˜é‡ */
            --color-primary: #4a6d7c;
            --color-secondary: #147a61;
            --color-success: #6b9c70;
            --color-warning: #e67e22;
            --color-danger: #d35400;
            --color-light-gray: #cbd5e1;
            --color-medium-gray: #64748b;
            --color-dark-gray: #2c3e50;
            --color-white: #ffffff;
            --color-black: #000000;
            --color-gradient-start: #4a6d7c;
            --color-gradient-mid1: #8da383;
            --color-gradient-mid2: #8a6a9c;
            --color-gradient-mid3: #d18a66;
            --color-gradient-end: #147a61;
            
            /* é€æ˜åº¦ */
            --opacity-light: 0.3;
            --opacity-medium: 0.5;
            --opacity-heavy: 0.7;
            
            /* å°ºå¯¸å˜é‡ */
            --border-radius-small: 4px;
            --border-radius-medium: 8px;
            --border-radius-large: 12px;
            --spacing-xs: 2px;
            --spacing-sm: 4px;
            --spacing-md: 8px;
            --spacing-lg: 12px;
            --spacing-xl: 20px;
            --spacing-xxl: 25px;
            
            /* é˜´å½± */
            --shadow-light: 0 4px 12px rgba(0,0,0,0.2);
            --shadow-medium: 0 10px 30px rgba(0,0,0,0.3);
            --shadow-heavy: 0 25px 50px rgba(0,0,0,0.2);
            
            /* å­—ä½“å¤§å° */
            --font-size-xs: 9px;
            --font-size-sm: 12px;
            --font-size-md: 14px;
            --font-size-lg: 18px;
            --font-size-xl: 20px;
            --font-size-xxl: 24px;
            
            /* è¿‡æ¸¡æ•ˆæœ */
            --transition-fast: 0.1s ease;
            --transition-medium: 0.2s ease;
            --transition-slow: 0.8s ease;
        }

        /* ========== åŸºç¡€é‡ç½® ========== */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }

        /* ========== ä¸»ä½“æ ·å¼ ========== */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(-45deg, 
                var(--color-gradient-start), 
                var(--color-gradient-mid1), 
                var(--color-gradient-mid2), 
                var(--color-gradient-mid3), 
                var(--color-gradient-end));
            background-size: 400% 400%;
            animation: gradientBG var(--animation-bg-speed) ease infinite;
            background-attachment: fixed;
            min-height: 100vh; 
            padding: var(--spacing-sm) var(--spacing-xl) var(--spacing-xl);
            display: flex; 
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: all var(--transition-fast);
        }

        /* æ¨¡å¼ç±» */
        body.mode-6 { }
        body.mode-9 { }
        body.mode-12 { }

        /* èƒŒæ™¯åŠ¨ç”» */
        @keyframes gradientBG { 
            0% { background-position: 0% 50%; } 
            50% { background-position: 100% 50%; } 
            100% { background-position: 0% 50%; } 
        }

        /* ========== ä¸»å¡ç‰‡æ ·å¼ ========== */
        .main-card {
            width: 100%; 
            max-width: 1050px;
            background: rgba(235, 230, 230, 0.75); 
            backdrop-filter: blur(15px); 
            border-radius: var(--border-radius-large); 
            padding: 40px;
            box-shadow: var(--shadow-heavy);
            transition: all var(--transition-fast);
        }

        /* ========== å¤´éƒ¨æ ·å¼ ========== */
        .header { 
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .header h1 { 
            color: var(--color-dark-gray); 
            text-align: center; 
            font-size: var(--font-size-xxl); 
            padding-bottom: 6px;
            margin-bottom: var(--spacing-sm); 
            letter-spacing: 2px; 
            font-weight: 600; 
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        /* å¤´éƒ¨æŒ‰é’®é€šç”¨æ ·å¼ - å·²æŒ‰è¦æ±‚ä¿®æ”¹å°ºå¯¸å’Œå­—å· */
        .header-btn {
            position: absolute;
            top: 0;
            background: rgba(255, 255, 255, var(--opacity-light));
            border: 1px solid rgba(var(--color-primary-rgb), var(--opacity-light));
            border-radius: var(--border-radius-medium);
            width: 36px;
            height: 36px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-medium);
			z-index: 10; 
        }
        
        .header-btn:hover {
            background: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
			box-shadow: 0 4px 5px rgba(0,0,0,0.2);
        }
		
        
        /* é¦–é¡µæŒ‰é’® - å·²æŒ‰è¦æ±‚ä¿®æ”¹å°ºå¯¸å’Œå­—å· */
        .home-btn {
            position: absolute !important;
            right: 84px !important;	
            width: 36px !important;
            height: 36px !important;
            font-size: 18px !important;		
        }
        
        /* å‘ç¥¨æŒ‰é’® - å·²æŒ‰è¦æ±‚ä¿®æ”¹å°ºå¯¸å’Œå­—å· */
        .invoice-btn {
            position: absolute !important;
            right: 42px !important;
            width: 36px !important;
            height: 36px !important;
            font-size: 18px !important;
        }
        
        /* å¸®åŠ©æŒ‰é’® - å·²æŒ‰è¦æ±‚ä¿®æ”¹å°ºå¯¸å’Œå­—å· */
        .help-btn {
            position: absolute !important;
            right: 0 !important;
            width: 36px !important;
            height: 36px !important;
            font-size: 18px !important;
        }

        /* ========== é¡¶éƒ¨å¸ƒå±€ ========== */
        .top-layout { 
            display: flex; 
            gap: var(--spacing-lg); 
			margin-top: 8px;
            margin-bottom: var(--spacing-sm); 
            align-items: stretch; 
        }
        
        /* ========== æ‹–æ‹½åŒºåŸŸå®¹å™¨ ========== */
        .drop-zone-container { 
            flex: 1.2; 
            display: flex; 
            flex-direction: column; 
            gap: var(--spacing-sm); 
        }
        
        /* æ‹–æ‹½åŒºåŸŸ */
        .drop-zone {
            flex: 1; 
            border: 0.5px dashed var(--color-primary); 
            border-radius: var(--border-radius-large);
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            text-align: center; 
            padding: var(--spacing-xxl); 
            cursor: pointer; 
            background: rgba(255, 255, 255, var(--opacity-medium));
            box-shadow: var(--shadow-light);
            transition: all var(--transition-fast);
        }
        
        .drop-zone:hover { 
            background: rgba(255, 255, 255, 0.6); 
            transform: translateY(-2px);
        }
        
        .upload-icon { 
            font-size: 40px; 
            color: var(--color-primary); 
            margin-bottom: 10px; 
        }
        
        .upload-text { 
            font-size: var(--font-size-lg); 
            font-weight: 600; 
            color: var(--color-dark-gray); 
            margin-bottom: var(--spacing-md); 
        }
        
        .upload-subtext { 
            font-size: var(--font-size-md); 
            color: #576574; 
        }
        
        .upload-subtext span { 
            color: #b97980; 
            text-decoration: underline; 
        }
        
        .upload-limit { 
            font-size: var(--font-size-sm); 
            color: #576574; 
            margin-top: var(--spacing-sm); 
        }

        /* åé¦ˆåŒºåŸŸ */
        #feedbackArea { 
            display: none; 
            text-align: center; 
        }
        
        .success-msg { 
            color: var(--color-secondary); 
            font-size: var(--font-size-lg); 
            font-weight: 700; 
            margin-bottom: var(--spacing-xs); 
        }
        
        .reset-hint { 
            color: var(--color-warning); 
            font-size: var(--font-size-md); 
            font-weight: 500; 
            margin-top: var(--spacing-xs);
        }

        /* ========== æ–‡ä»¶åˆ—è¡¨æ ·å¼ ========== */
        .file-list-container {
            width: 100%;
            margin: var(--spacing-md) 0;
        }
        
        .file-list-header {
            font-size: 13px;
            font-weight: 600;
            color: var(--color-dark-gray);
            margin-bottom: 6px;
            padding-bottom: var(--spacing-xs);
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        .file-list-scroll {
            max-height: 180px;
            overflow-y: auto;
            overflow-x: hidden;
            border: 1px solid rgba(var(--color-primary-rgb), 0.2);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.3);
            padding: var(--spacing-xs);
        }
        
        .file-list {
            font-size: var(--font-size-sm);
        }
        
        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-xs) var(--spacing-xs);
            margin: 1px 0;
            background: rgba(255, 255, 255, var(--opacity-medium));
            border-radius: var(--border-radius-small);
            border-left: 2px solid var(--color-primary);
            min-height: 20px;
            position: relative;
        }
        
        .file-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: var(--spacing-md);
            font-size: 10px;
            max-width: 180px;
        }
        
        .file-status {
            font-size: var(--font-size-xs);
            padding: 1px var(--spacing-xs);
            border-radius: 8px;
            background: var(--color-success);
            color: var(--color-white);
            white-space: nowrap;
        }
        
        /* æ–‡ä»¶åæ‚¬åœæç¤º */
        .file-item:hover::after {
            content: attr(title);
            position: absolute;
            top: 100%;
            left: 0;
            background: rgba(0, 0, 0, 0.85);
            color: var(--color-white);
            padding: 6px 10px;
            border-radius: var(--border-radius-small);
            font-size: 11px;
            white-space: normal;
            max-width: 300px;
            z-index: 100;
            pointer-events: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        /* ========== è¿›åº¦æ¡æ ·å¼ ========== */
        .progress-wrapper { 
            position: relative; 
            height: 24px; 
            background: rgba(0, 0, 0, 0.1); 
            border-radius: var(--border-radius-large); 
            overflow: hidden; 
            display: none; 
        }
        
        .progress-bar { 
            height: 100%; 
            width: 0%; 
            background: linear-gradient(90deg, #77b282, #429852, #0c7820);
            transition: width var(--transition-slow);
        }
        
        .progress-text { 
            position: absolute; 
            width: 100%; 
            height: 100%; 
            top: 0; 
            left: 0; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: var(--font-size-sm); 
            font-weight: 500; 
            color: var(--color-white); 
            pointer-events: none; 
        }

        /* ========== è®¾ç½®é¢æ¿ ========== */
        .settings-panel { 
            flex: 1; 
            display: grid; 
            grid-template-columns: 1fr 1fr;
            gap: 10px; 
        }

        .setting-unit { 
            height: 100%;
            background: rgba(170, 180, 180, 0.75); 
            border-radius: var(--border-radius-large); 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            box-shadow: var(--shadow-light);
            transition: transform var(--transition-fast);
        }
        
        .setting-unit:hover {
            transform: translateY(-2px);
        }
        
        .unit-full { 
            grid-column: span 1; 
        }
        
        .unit-header { 
            font-size: var(--font-size-md); 
            font-weight: 600; 
            color: var(--color-dark-gray); 
            margin-bottom: var(--spacing-md); 
        }

        /* ========== æŒ‰é’®æ ·å¼ ========== */
        /* è£å‰ªçº¿å¼€å…³æŒ‰é’® */
        .toggle-btn { 
            width: 70%; 
            height: 35px; 
            border-radius: var(--border-radius-large); 
            border: none; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all var(--transition-fast); 
        }
        
        .btn-on { 
            background: var(--color-success); 
            color: var(--color-white); 
        }
        
        .btn-off { 
            background: var(--color-light-gray); 
            color: var(--color-medium-gray); 
        }

        /* æ¨¡å¼é€‰æ‹©æŒ‰é’®ç»„ */
        .mode-group { 
            display: flex; 
            flex-direction: column;
			align-items: center;
            gap: var(--spacing-xl); 
            width: 80%; 
        }

        .mode-group.vertical {
            flex-direction: column;
            gap: 10px;
        }
        
        /* æ¨¡å¼æŒ‰é’® */
        .btn-mode { 
            flex: 0 0 auto; 
            width: 100px; 
            height: 35px;
            border-radius: var(--border-radius-large); 
            border: 1px solid var(--color-light-gray); 
            background: var(--color-light-gray); 
            color: var(--color-primary); 
            font-weight: 600; 
            cursor: pointer; 
            transition: all var(--transition-fast);
            font-size: var(--font-size-md);
        }
        
        .btn-mode:hover {
            border-color: var(--color-primary);
        }
        
        .btn-mode.active { 
            background: var(--color-success); 
            color: var(--color-white); 
            border-color: var(--color-primary); 
        }

        /* ========== å·¥å…·æ  ========== */
        .toolbar { 
            display: flex; 
            gap: var(--spacing-xl); 
            margin-top: var(--spacing-xl); 
        }
        
        /* å¤§æŒ‰é’® */
        .btn-large { 
            flex: 1; 
            height: 52px; 
            border-radius: var(--border-radius-large); 
            border: none; 
            font-weight: 700; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
            color: var(--color-white); 
            transition: all var(--transition-fast);
        }
        
        .btn-large:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-large:disabled { 
            opacity: 0.3; 
            cursor: not-allowed; 
            transform: none !important;
            box-shadow: none !important;
        }
        
        .btn-pdf { 
            background: #94a3b8; 
        }
        
        .btn-print { 
            background: var(--color-secondary); 
        }
        
        .btn-reset { 
            background: var(--color-white); 
            color: var(--color-medium-gray); 
            border: 1px solid var(--color-light-gray); 
        }
        
        .btn-reset:hover {
            background: #f8fafc;
            border-color: #94a3b8;
        }

        /* ========== é¢„è§ˆç½‘æ ¼ ========== */
        #previewGrid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: var(--spacing-xl); 
            margin-top: var(--spacing-xl); 
            width: 100%;
        }
        
        .preview-page { 
            background: var(--color-white); 
            position: relative; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.2); 
            margin: 0 auto; 
            overflow: hidden; 
            transition: transform var(--transition-fast);
            width: 100%;
        }
        
        .preview-page:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        
        /* é¡µé¢æ–¹å‘ */
        .v-page { 
            aspect-ratio: 210/297; 
        } 
        
        .h-page { 
            aspect-ratio: 297/210; 
        }

        /* ========== 9å¼ æ¨¡å¼ç‰¹æ®Šæ ·å¼ ========== */
        body.mode-9 .slot {
            overflow: hidden !important;
            display: flex !important;
            align-items: flex-start !important;
            justify-content: center !important;
            background: var(--color-white) !important;
        }

        body.mode-9 .slot img {
            width: 100% !important;
            min-height: 100% !important;
            object-fit: cover !important;
            object-position: top center !important;
            background: var(--color-white) !important;
        }

        /* ========== è£å‰ªçº¿æ ·å¼ ========== */
        .cut-line {
            position: absolute;
            pointer-events: none;
            z-index: 10;
        }
        
        .cut-line.vertical {
            border-left: 0.5px dashed var(--color-danger);
            height: 100%;
        }
        
        .cut-line.horizontal {
            border-top: 0.5px dashed var(--color-danger);
            width: 100%;
        }

        /* ========== æ§½ä½æ ·å¼ ========== */
        .slot { 
            position: absolute; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            box-sizing: border-box;
            background: var(--color-white);
            overflow: hidden;
            z-index: 1;
        }
        
        .slot img { 
            width: 100%; 
            height: 100%; 
            object-fit: contain; 
            display: block;
            background: var(--color-white);
        }

        /* ========== æµè§ˆå™¨å…¼å®¹æ€§è­¦å‘Š ========== */
        .browser-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #ffcc00;
            color: #333;
            padding: 10px 15px;
            text-align: center;
            font-size: var(--font-size-md);
            font-weight: 500;
            z-index: 9999;
            display: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .browser-warning-content {
            max-width: 1050px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .browser-warning-close {
            background: none;
            border: none;
            font-size: var(--font-size-xl);
            cursor: pointer;
            color: #333;
            padding: 0 10px;
        }

        /* ========== æ‰“å°ç›¸å…³æ ·å¼ ========== */
        @media print {
            /* éšè—æ‰€æœ‰éæ‰“å°å†…å®¹ */
            body * {
                visibility: hidden;
            }
            
            /* åªæ˜¾ç¤ºé¢„è§ˆç½‘æ ¼ */
            #previewGrid,
            #previewGrid * {
                visibility: visible;
            }
            
            /* å¼ºåˆ¶çºµå‘æ‰“å°æ ·å¼ - 6å¼ æ¨¡å¼ */
            body.mode-6 .preview-page {
                size: A4 portrait !important;
                width: 210mm !important;
                height: 297mm !important;
                transform: none !important;
                box-shadow: none !important;
                page-break-after: always !important;
                page-break-inside: avoid !important;
                break-inside: avoid !important;
                overflow: visible !important;
            }
            
            /* å¼ºåˆ¶çºµå‘æ‰“å°æ ·å¼ - 9å¼ æ¨¡å¼ */
            body.mode-9 .preview-page {
                size: A4 portrait !important;
                width: 210mm !important;
                height: 297mm !important;
                transform: none !important;
                box-shadow: none !important;
                page-break-after: always !important;
                page-break-inside: avoid !important;
                break-inside: avoid !important;
                overflow: visible !important;
            }
            
            /* å¼ºåˆ¶æ¨ªå‘æ‰“å°æ ·å¼ - 12å¼ æ¨¡å¼ */
            body.mode-12 .preview-page {
                size: A4 landscape !important;
                width: 297mm !important;
                height: 210mm !important;
                transform: none !important;
                box-shadow: none !important;
                page-break-after: always !important;
                page-break-inside: avoid !important;
                break-inside: avoid !important;
                overflow: visible !important;
            }
            
            /* 9å¼ æ¨¡å¼æ‰“å°æ ·å¼ */
            body.mode-9 .slot {
                overflow: hidden !important;
                display: flex !important;
                align-items: flex-start !important;
                justify-content: center !important;
                background: var(--color-white) !important;
            }
            
            body.mode-9 .slot img {
                width: 100% !important;
                min-height: 100% !important;
                object-fit: cover !important;
                object-position: top center !important;
                background: var(--color-white) !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            /* æ‰“å°æ—¶çš„è£å‰ªçº¿æ ·å¼ */
            .cut-line.vertical {
                border-left: 0.3mm dashed #AAAAAA !important;
            }
            
            .cut-line.horizontal {
                border-top: 0.3mm dashed #AAAAAA !important;
            }
            
            /* é¡µé¢è®¾ç½® */
            @page {
                margin: 0;
                size: auto;
            }
            
            /* é’ˆå¯¹ä¸åŒæ¨¡å¼è®¾ç½®é¡µé¢æ–¹å‘ */
            @page portrait-page {
                size: A4 portrait;
                margin: 0;
            }
            
            @page landscape-page {
                size: A4 landscape;
                margin: 0;
            }
            
            body.mode-6 .preview-page,
            body.mode-9 .preview-page {
                page: portrait-page;
            }
            
            body.mode-12 .preview-page {
                page: landscape-page;
            }
            
            /* é‡ç½®bodyæ ·å¼ */
            body {
                background: var(--color-white) !important;
                padding: 0 !important;
                margin: 0 !important;
                min-height: auto;
                animation: none !important;
                display: block !important;
                width: 100% !important;
                height: auto !important;
                overflow: visible !important;
            }
            
            /* ä¸»å¡ç‰‡æ ·å¼é‡ç½® */
            .main-card {
                background: none !important;
                box-shadow: none !important;
                border: none !important;
                padding: 0 !important;
                margin: 0 !important;
                max-width: none !important;
                backdrop-filter: none !important;
                width: 100% !important;
                height: auto !important;
                display: block !important;
                overflow: visible !important;
            }
            
            /* éšè—æ‰€æœ‰éå¿…è¦å…ƒç´  */
            .header,
            .top-layout,
            .toolbar,
            .drop-zone-container,
            .settings-panel,
            .progress-wrapper,
            .upload-icon,
            .upload-text,
            .upload-subtext,
            .upload-limit,
            .browser-warning,
            .print-dialog,
            .help-dialog,
            .footer,
            .file-list-container,
            .success-msg,
            .reset-hint {
                display: none !important;
            }
            
            /* é¢„è§ˆç½‘æ ¼æ‰“å°æ ·å¼ */
            #previewGrid {
                display: block !important;
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                height: auto !important;
                position: static !important;
                top: auto !important;
                left: auto !important;
                grid-template-columns: none !important;
                gap: 0 !important;
                overflow: visible !important;
            }
            
            /* é¢„è§ˆé¡µé¢æ‰“å°æ ·å¼ */
            .preview-page {
                box-shadow: none !important;
                margin: 0 !important;
                border: none !important;
                overflow: visible !important;
                transform: none !important;
                position: relative !important;
                page-break-after: always !important;
                page-break-inside: avoid !important;
                break-inside: avoid !important;
                display: block !important;
                background: var(--color-white) !important;
            }
            
            /* æœ€åä¸€é¡µä¸æ·»åŠ åˆ†é¡µ */
            .preview-page:last-child {
                page-break-after: auto !important;
            }
            
            /* æ§½ä½æ ·å¼ */
            .slot {
                background: var(--color-white) !important;
            }
            
            .slot img {
                filter: none !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            /* ç¡®ä¿æ‰“å°æ—¶é¢„è§ˆé¡µé¢å®Œå…¨å¡«å……çº¸å¼  */
            .preview-page.v-page {
                width: 210mm !important;
                height: 297mm !important;
                aspect-ratio: auto !important;
            }
            
            .preview-page.h-page {
                width: 297mm !important;
                height: 210mm !important;
                aspect-ratio: auto !important;
            }
        }

        /* ========== å¼¹çª—æ ·å¼ ========== */
        /* æ‰“å°å¯¹è¯æ¡† */
        .print-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .print-dialog-content {
            background: var(--color-white);
            padding: 30px;
            border-radius: var(--border-radius-large);
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow-medium);
        }
        
        .print-dialog h3 {
            color: var(--color-dark-gray);
            margin-bottom: 15px;
            font-size: var(--font-size-xl);
            text-align: center;
        }
        
        .print-dialog p {
            color: #576574;
            margin-bottom: 10px;
            line-height: 1.5;
        }
        
        .print-dialog strong {
            color: var(--color-warning);
        }
        
        .print-dialog-buttons {
            display: flex;
            gap: 15px;
            margin-top: var(--spacing-xxl);
        }
        
        .print-dialog-btn {
            flex: 1;
            padding: var(--spacing-sm);
            border: none;
            border-radius: var(--border-radius-medium);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-medium);
        }
        
        .print-dialog-confirm {
            background: var(--color-secondary);
            color: var(--color-white);
        }
        
        .print-dialog-confirm:hover {
            background: #0d5d49;
        }
        
        .print-dialog-cancel {
            background: #f1f5f9;
            color: var(--color-medium-gray);
            border: 1px solid var(--color-light-gray);
        }
        
        .print-dialog-cancel:hover {
            background: #e2e8f0;
        }
        
        .print-tip {
            margin-top: 10px;
            font-size: 13px;
            color: #94a3b8;
            font-style: italic;
        }
        
        /* å¸®åŠ©å¼¹çª— */
        .help-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }
        
        .help-dialog-content {
            background: var(--color-white);
            padding: 30px;
            border-radius: var(--border-radius-large);
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-medium);
            position: relative;
        }
        
        .help-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--color-medium-gray);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-medium);
        }
        
        .help-close:hover {
            background: #f1f5f9;
            color: var(--color-dark-gray);
        }
        
        .help-dialog h2 {
            color: var(--color-dark-gray);
            margin-bottom: var(--spacing-xl);
            font-size: var(--font-size-xxl);
            text-align: center;
            padding-right: 30px;
        }
        
        .help-section {
            margin-bottom: var(--spacing-xl);
        }
        
        .help-section h3 {
            color: var(--color-secondary);
            font-size: var(--font-size-lg);
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }
        
        .help-section p {
            color: #576574;
            line-height: 1.6;
            margin-bottom: var(--spacing-md);
            padding-left: 28px;
        }
        
        .help-tip {
            background: rgba(20, 122, 97, 0.1);
            border-left: 3px solid var(--color-secondary);
            padding: 10px 15px;
            margin: 15px 0;
            border-radius: 0 6px 6px 0;
            font-size: var(--font-size-md);
        }

        /* ========== åº•éƒ¨æ ·å¼ ========== */
        .footer {
            width: 100%;
            max-width: 1050px;
            text-align: center;
            padding: 15px 0;
            color: var(--color-medium-gray);
            font-size: var(--font-size-md);
            margin-top: var(--spacing-xl);
        }
        
        .footer a {
            color: var(--color-secondary);
            text-decoration: none;
            font-weight: 600;
            transition: color var(--transition-medium);
        }
        
        .footer a:hover {
            color: #0d5d49;
            text-decoration: underline;
        }

        /* ========== å“åº”å¼è°ƒæ•´ ========== */
        @media (max-width: 768px) {
            .file-name {
                max-width: 120px;
                font-size: 9px;
            }
            
            .file-status {
                font-size: 8px;
                padding: 1px var(--spacing-xs);
            }
            
            .help-dialog-content {
                padding: var(--spacing-xl);
                max-height: 85vh;
            }
            
            .header h1 {
                font-size: var(--font-size-xl);
            }
            
            /* ç§»åŠ¨ç«¯ä¿ç•™ä¿®æ”¹åçš„å°ºå¯¸ */
            .help-btn {
                width: 36px !important;
                height: 36px !important;
                font-size: 18px !important;
            }
            
            #previewGrid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 15px;
            }
            
            /* ç§»åŠ¨ç«¯ä¿ç•™ä¿®æ”¹åçš„å°ºå¯¸ */
            .home-btn {
                width: 36px !important;
                height: 36px !important;
                font-size: 18px !important;
                right: 84px !important;
            }
            
            /* ç§»åŠ¨ç«¯ä¿ç•™ä¿®æ”¹åçš„å°ºå¯¸ */
            .invoice-btn {
                width: 36px !important;
                height: 36px !important;
                font-size: 18px !important;
                right: 42px !important;
            }
            
            /* å“åº”å¼è°ƒæ•´æ¨¡å¼æŒ‰é’®é«˜åº¦ */
            .btn-mode {
                height: 30px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body id="theBody" class="mode-9">
    <div class="browser-warning" id="browserWarning">
        <div class="browser-warning-content">
            <div>âš ï¸ æ‚¨çš„æµè§ˆå™¨å¯èƒ½ä¸å®Œå…¨æ”¯æŒæ‰€æœ‰åŠŸèƒ½ï¼Œå»ºè®®ä½¿ç”¨ Chromeã€Edge æˆ– Firefox æœ€æ–°ç‰ˆæœ¬</div>
            <button class="browser-warning-close" onclick="closeBrowserWarning()">Ã—</button>
        </div>
    </div>
    
    <div class="print-dialog" id="printDialog">
        <div class="print-dialog-content">
            <h3>ğŸ–¨ï¸ æ‰“å°è®¾ç½®æç¤º</h3>
            <p>å½“å‰å¸ƒå±€æ¨¡å¼ï¼š<strong id="printModeText">1é¡µ9å¼ (çºµå‘)</strong></p>
            <p>è¯·åœ¨ç¨åçš„æ‰“å°è®¾ç½®ä¸­ç¡®è®¤ä»¥ä¸‹äº‹é¡¹ï¼š</p>
            <p>1. <strong>çº¸å¼ æ–¹å‘</strong>ï¼šè®¾ç½®ä¸º <strong id="printOrientationText">çºµå‘</strong></p>
            <p>2. <strong>çº¸å¼ å¤§å°</strong>ï¼šè®¾ç½®ä¸º <strong>A4</strong></p>
            <p>3. <strong>é¡µè¾¹è·</strong>ï¼šè®¾ç½®ä¸º <strong>æ— </strong> æˆ– <strong>æœ€å°</strong></p>
            <p>4. <strong>ç¼©æ”¾æ¯”ä¾‹</strong>ï¼šè®¾ç½®ä¸º <strong>100%</strong> æˆ– <strong>é»˜è®¤</strong></p>
            <p class="print-tip">ğŸ’¡ æç¤ºï¼šè£å‰ªçº¿å·²å¼€å¯ï¼Œæ‰“å°åå¯æŒ‰è™šçº¿è£å‰ª</p>
            <div class="print-dialog-buttons">
                <button class="print-dialog-btn print-dialog-confirm" id="confirmPrint">ç¡®è®¤è®¾ç½®å¹¶æ‰“å°</button>
                <button class="print-dialog-btn print-dialog-cancel" id="cancelPrint">å–æ¶ˆæ‰“å°</button>
            </div>
        </div>
    </div>
    
    <div class="help-dialog" id="helpDialog">
        <div class="help-dialog-content">
            <button class="help-close" onclick="closeHelp()">Ã—</button>
            <h2>ğŸ“š ä½¿ç”¨è¯´æ˜</h2>
            
            <div class="help-section">
                <h3>ğŸ“‹ å·¥å…·ç®€ä»‹</h3>
                <p>æ‰‹æœºæˆªå›¾æ‰¹é‡æ‰“å°æ˜¯ä¸€ä¸ªä¸“ä¸ºé«˜æ•ˆæ‰“å°ç«–ç‰ˆæ‰‹æœºæˆªå›¾è®¾è®¡çš„åœ¨çº¿å·¥å…·ï¼Œæ”¯æŒå°†å¤šå¼ æ‰‹æœºæˆªå›¾æ™ºèƒ½æ’ç‰ˆåˆ°A4çº¸ä¸Šï¼Œå®ç°è§„èŒƒã€ç»æµçš„æ‰¹é‡æ‰“å°ã€‚</p>
            </div>
            
            <div class="help-section">
                <h3>ğŸš€ å¿«é€Ÿå¼€å§‹</h3>
                <p><strong>1. åŠ è½½æ‰‹æœºæˆªå›¾æ–‡ä»¶</strong>ï¼šå°†æ‰‹æœºæˆªå›¾æ‹–å…¥è™šçº¿åŒºåŸŸæˆ–ç‚¹å‡»"ç‚¹å‡»åŠ è½½"æŒ‰é’®</p>
                <p><strong>2. é€‰æ‹©æ‰“å°å¸ƒå±€</strong>ï¼š1é¡µ6å¼ (çºµå‘)ã€1é¡µ9å¼ (çºµå‘)æˆ–1é¡µ12å¼ (æ¨ªå‘)å¸ƒå±€</p>
                <p><strong>3. è°ƒæ•´è£å‰ªçº¿</strong>ï¼šæ ¹æ®éœ€è¦å¼€å¯æˆ–å…³é—­è£å‰ªçº¿</p>
                <p><strong>4. é¢„è§ˆä¸è°ƒæ•´</strong>ï¼šæŸ¥çœ‹æ’ç‰ˆæ•ˆæœï¼Œç¡®è®¤æ— è¯¯</p>
                <p><strong>5. å¯¼å‡ºä¸æ‰“å°</strong>ï¼šå¯¼å‡ºPDFæˆ–ç›´æ¥æ‰“å°</p>
            </div>
            
            <div class="help-section">
                <h3>ğŸ§© å¸ƒå±€é€‰æ‹©</h3>
                <p><strong>1é¡µ6å¼ (çºµå‘)</strong>ï¼šA4çº¸çºµå‘æ’ç‰ˆï¼Œ3åˆ—Ã—2è¡Œï¼Œé€‚åˆæ ‡å‡†æ‰“å°</p>
                <p><strong>1é¡µ9å¼ (çºµå‘)</strong>ï¼šA4çº¸çºµå‘æ’ç‰ˆï¼Œ3åˆ—Ã—3è¡Œï¼Œé»˜è®¤æ¨èï¼Œå¹³è¡¡æ¸…æ™°åº¦ä¸æ•ˆç‡</p>
                <p><strong>1é¡µ12å¼ (æ¨ªå‘)</strong>ï¼šA4çº¸æ¨ªå‘æ’ç‰ˆï¼Œ6åˆ—Ã—2è¡Œï¼Œæœ€ç»æµé«˜æ•ˆ</p>
                <p>ğŸ’¡ <strong>9å¼ æ¨¡å¼ç‰¹ç‚¹</strong>ï¼šä¿ç•™å›¾ç‰‡å®½åº¦ï¼Œä¿æŒåŸå§‹æ¯”ä¾‹ï¼Œé¡¶éƒ¨å¯¹é½ï¼Œã€åº•éƒ¨ã€‘æ— ç”¨ä¿¡æ¯è‡ªåŠ¨è£å‰ª</p>
            </div>
            
            <div class="help-section">
                <h3>âœ‚ï¸ è£å‰ªçº¿åŠŸèƒ½</h3>
                <p><strong>ä½œç”¨</strong>ï¼šåœ¨æ‰‹æœºæˆªå›¾é—´éš”ä¸­æ·»åŠ å‚è€ƒè™šçº¿ï¼Œå¸®åŠ©æ‰“å°åç²¾ç¡®è£å‰ª</p>
                <p><strong>æ˜¾ç¤º</strong>ï¼šé¢„è§ˆæ—¶æ˜¾ç¤ºæ©™è‰²è™šçº¿ï¼Œæ‰“å°æ—¶æ˜¾ç¤ºæµ…ç°è‰²è™šçº¿</p>
                <p><strong>ä½ç½®</strong>ï¼šåœ¨æ‰‹æœºæˆªå›¾é—´éš”æ­£ä¸­é—´ï¼ˆ4.3mmé—´è·ä¸­é—´ï¼‰</p>
                <p>ğŸ’¡ å»ºè®®å¼€å¯è£å‰ªçº¿ï¼Œç‰¹åˆ«æ˜¯éœ€è¦ç²¾ç¡®è£å‰ªæ—¶</p>
            </div>
            
            <div class="help-section">
                <h3>âš™ï¸ æ‰“å°è®¾ç½®</h3>
                <p><strong>æ™ºèƒ½æ–¹å‘æ£€æµ‹</strong>ï¼šæ ¹æ®å¸ƒå±€è‡ªåŠ¨è®¾ç½®æ‰“å°æ–¹å‘</p>
                <p><strong>å›ºå®šè¾¹è·</strong>ï¼šé¡µè¾¹è·å’Œæ‰‹æœºæˆªå›¾é—´è·å‡ä¸º4.3mmï¼Œç¡®ä¿æ‰“å°ç²¾åº¦</p>
                <p>ğŸ’¡ 1é¡µ6å¼ å’Œ9å¼ æ¨¡å¼è‡ªåŠ¨è®¾ç½®ä¸ºçºµå‘æ‰“å°ï¼Œ1é¡µ12å¼ æ¨¡å¼è‡ªåŠ¨è®¾ç½®ä¸ºæ¨ªå‘æ‰“å°</p>
            </div>
            
            <div class="help-section">
                <h3>ğŸ’¾ å¯¼å‡ºä¸æ‰“å°</h3>
                <p><strong>å¯¼å‡º PDF</strong>ï¼šå°†æ‰€æœ‰æ‰‹æœºæˆªå›¾åˆå¹¶æˆä¸€ä¸ªPDFæ–‡ä»¶ä¿å­˜ã€9å¼ æ¨¡å¼PDFå¯¼å‡ºå®Œæ•´åº¦ä¿ç•™ã€‘</p>
                <p><strong>ç«‹å³æ‰“å°</strong>ï¼šç›´æ¥è°ƒç”¨æµè§ˆå™¨æ‰“å°åŠŸèƒ½ï¼Œæ™ºèƒ½æç¤ºæ‰“å°è®¾ç½®</p>
                <p><strong>æ¸…ç©ºé‡ç½®</strong>ï¼šæ¸…é™¤æ‰€æœ‰æ–‡ä»¶ï¼Œé‡æ–°å¼€å§‹æ–°ä»»åŠ¡</p>
            </div>
            
            <div class="help-section">
                <h3>ğŸ¯ ä½¿ç”¨æŠ€å·§</h3>
                <p><strong>æœ€ä½³å®è·µ</strong>ï¼šç¡®ä¿æ‰‹æœºæˆªå›¾ä¸ºç«–ç‰ˆ3:4æ¯”ä¾‹ï¼Œæ•ˆæœæœ€ä½³</p>
                <p><strong>æµ‹è¯•æ‰“å°</strong>ï¼šé‡è¦æ‰‹æœºæˆªå›¾å…ˆå¯¼å‡ºä¸€é¡µæµ‹è¯•æ‰“å°æ•ˆæœ</p>
                <p><strong>è£å‰ªå»ºè®®</strong>ï¼šæ²¿ç€è£å‰ªçº¿è™šçº¿ä¸­å¿ƒè£å‰ªæœ€å‡†ç¡®</p>
                <p><strong>æ–‡ä»¶åˆ—è¡¨</strong>ï¼šå¯æ˜¾ç¤ºå·²åŠ è½½çš„æ‰€æœ‰æ–‡ä»¶åï¼Œæ‚¬åœæŸ¥çœ‹å®Œæ•´åç§°</p>
                <p><strong>9å¼ æ¨¡å¼ä¼˜åŠ¿</strong>ï¼šç›¸æ¯”6å¼ æ¨¡å¼æ›´ç»æµï¼Œç›¸æ¯”12å¼ æ¨¡å¼æ›´æ¸…æ™°ï¼Œæ¨èæ—¥å¸¸ä½¿ç”¨</p>
            </div>
            
            <div class="help-tip">
                <strong>ğŸ’¡ æ¸©é¦¨æç¤ºï¼š</strong> æ‰“å°å‰è¯·ç¡®ä¿æ‰“å°æœºå·²è¿æ¥å¹¶æœ‰è¶³å¤Ÿçº¸å¼ ã€‚å»ºè®®å…ˆå¯¼å‡ºä¸€é¡µè¿›è¡Œæµ‹è¯•æ‰“å°ã€‚
            </div>
            
            <div class="help-section">
                <h3>âš ï¸ é‡è¦æç¤º</h3>
                <p><strong>æ ¼å¼æ”¯æŒ</strong>ï¼šæ”¯æŒJPGã€PNGã€WEBPç­‰å¸¸è§å›¾ç‰‡æ ¼å¼</p>
                <p><strong>æ¯”ä¾‹ä¿æŒ</strong>ï¼šæ‰€æœ‰æ‰‹æœºæˆªå›¾è‡ªåŠ¨æŒ‰(3:4)æ¯”ä¾‹ç¼©æ”¾ï¼Œä¸è£å‰ª</p>
                <p><strong>æµè§ˆå™¨è¦æ±‚</strong>ï¼šæ¨èä½¿ç”¨ Chromeã€Edgeæµè§ˆå™¨</p>
                <p><strong>æ–‡ä»¶é™åˆ¶</strong>ï¼šå•æ¬¡æœ€å¤šå¤„ç†50ä¸ªæ–‡ä»¶ï¼Œå•ä¸ªæ–‡ä»¶å»ºè®®ä¸è¶…è¿‡3MB</p>
                <p><strong>9å¼ æ¨¡å¼è¯´æ˜</strong>ï¼šå›¾ç‰‡å®½åº¦å¡«æ»¡ï¼Œé«˜åº¦æŒ‰åŸå§‹æ¯”ä¾‹ç¼©æ”¾ï¼Œé¡¶éƒ¨å¯¹é½æ˜¾ç¤ºï¼Œåº•éƒ¨è¶…å‡ºéƒ¨åˆ†è‡ªåŠ¨è£å‰ª</p>
            </div>
            
            <div class="help-section">
                <h3>ğŸ› ï¸ æ•…éšœæ’é™¤</h3>
                <p><strong>æ–‡ä»¶æ— æ³•åŠ è½½</strong>ï¼šæ£€æŸ¥æ˜¯å¦ä¸ºæ”¯æŒçš„å›¾ç‰‡æ ¼å¼</p>
                <p><strong>é¢„è§ˆä¸æ˜¾ç¤º</strong>ï¼šå°è¯•æ¸…ç©ºé‡ç½®åé‡æ–°åŠ è½½</p>
                <p><strong>æ‰“å°æ•ˆæœä¸ä½³</strong>ï¼šæ£€æŸ¥æ‰“å°æœºè®¾ç½®ï¼Œç¡®ä¿ä¸ºé«˜è´¨é‡æ‰“å°</p>
                <p><strong>æµè§ˆå™¨è­¦å‘Š</strong>ï¼šå»ºè®®æ›´æ¢ä¸ºæ¨èæµè§ˆå™¨</p>
                <p><strong>9å¼ æ¨¡å¼é—®é¢˜</strong>ï¼šå¦‚é‡å›¾ç‰‡æ˜¾ç¤ºå¼‚å¸¸ï¼Œè¯·å°è¯•åˆ‡æ¢å…¶ä»–æ¨¡å¼åè¿”å›</p>
            </div>
            
            <div class="help-section">
                <h3>ğŸ“ æ”¯æŒä¸åé¦ˆ</h3>
                <p>å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·ğŸ’¬<a href="https://ly.topmer.top" target="_blank" rel="noopener noreferrer">ç»™æˆ‘ç•™è¨€</a>ğŸ˜‰</p>
                <p>åé¦ˆæ—¶è¯·æ³¨æ˜ï¼šé‡åˆ°çš„é—®é¢˜ã€æµè§ˆå™¨ç‰ˆæœ¬ã€æ‰‹æœºæˆªå›¾æ•°é‡å’Œå¤§å°</p>
            </div>
            
            <div class="help-section">
                <h3>ğŸ“„ å…è´£å£°æ˜</h3>
                <p>1. æœ¬å·¥å…·ä»…å¤„ç†å›¾ç‰‡æ–‡ä»¶ï¼Œä¸å­˜å‚¨ç”¨æˆ·æ•°æ®</p>
                <p>2. æ‰“å°æ•ˆæœå—æ‰“å°æœºã€çº¸å¼ è´¨é‡ç­‰å› ç´ å½±å“</p>
                <p>3. å»ºè®®é‡è¦æ‰‹æœºæˆªå›¾å…ˆæµ‹è¯•æ‰“å°å†æ‰¹é‡å¤„ç†</p>
                <p>4. è¯·éµå®ˆç›¸å…³ç‰ˆæƒè§„å®šä½¿ç”¨æ‰‹æœºæˆªå›¾</p>
            </div>
        </div>
    </div>
    
    <div class="main-card">
        <div class="header">
            <h1>æ‰‹æœºæˆªå›¾æ‰¹é‡æ’ç‰ˆæ‰“å°</h1>
            <button class="header-btn home-btn" onclick="goToHomePage()" title="æ›´å¤šå·¥å…·">ğŸ </button>
            <button class="header-btn invoice-btn" onclick="openInvoiceTool()" title="å‘ç¥¨æ‰“å°">ğŸ§¾</button>
            <button class="header-btn help-btn" onclick="showHelp()" title="ä½¿ç”¨è¯´æ˜">â“</button>
        </div>
        <div class="top-layout">
            <div class="drop-zone-container">
                <div id="dropZone" class="drop-zone" onclick="document.getElementById('fileIn').click()">
                    <div class="upload-icon">ğŸ“¤</div>
                    <div class="upload-text">å°†æ‰‹æœºæˆªå›¾æ‹–å…¥æ­¤å¤„</div>
                    <div class="upload-subtext">æˆ– <span>ç‚¹å‡»åŠ è½½</span> (æ”¯æŒå¤šé€‰)</div>
                    <div class="upload-limit">âœ¨ ä»…é€‚ç”¨äºæ‰‹æœºæˆªå›¾ï¼Œæ¯æ¬¡ä¸è¶…è¿‡50å¼  âœ¨</div>
                    <input type="file" id="fileIn" accept="image/jpeg,image/png,image/jpg,image/webp" multiple style="display:none;">
                </div>
                
                <div id="feedbackArea" class="drop-zone">
                    <div id="successInfo" class="success-msg"></div>
                    
                    <div class="file-list-container">
                        <div class="file-list-header">ğŸ“„ å·²åŠ è½½æ–‡ä»¶ (<span id="fileCount">0</span>)</div>
                        <div class="file-list-scroll">
                            <div class="file-list" id="fileList"></div>
                        </div>
                    </div>
                    
                    <div class="reset-hint">ğŸ’¡ å¤„ç†æ–°çš„æ–‡ä»¶å‰è¯·å…ˆç‚¹å‡» "æ¸…ç©ºé‡ç½®" ğŸ’¡</div>
                </div>
                
                <div class="progress-wrapper" id="progressWrapper">
                    <div class="progress-bar" id="progressBar"></div>
                    <div class="progress-text" id="progressText">0 / 0</div>
                </div>
            </div>

            <div class="settings-panel">
                <div class="setting-unit">
                    <div class="unit-header">âœ‚ï¸ è£å‰ªçº¿</div>
                    <button id="cutLineToggle" class="toggle-btn btn-on" onclick="toggleCutLines()">å·²å¼€å¯</button>
                </div>
                
                <div class="setting-unit unit-full">
                    <div class="unit-header">ğŸ§© å¸ƒå±€é€‰æ‹©</div>
                    <div class="mode-group" style="flex-direction: column; gap: 10px;">
                        <button id="m6" class="btn-mode" onclick="setMode(6)">1é¡µ6å¼ (çºµå‘)</button>
                        <button id="m9" class="btn-mode active" onclick="setMode(9)">1é¡µ9å¼ (çºµå‘)</button>
                        <button id="m12" class="btn-mode" onclick="setMode(12)">1é¡µ12å¼ (æ¨ªå‘)</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="toolbar">
            <button id="exportBtn" class="btn-large btn-pdf" disabled onclick="savePDF()">ğŸ’¾ å¯¼å‡º PDF</button>
            <button id="printBtn" class="btn-large btn-print" disabled onclick="showPrintDialog()">ğŸ–¨ï¸ ç«‹å³æ‰“å°</button>
            <button class="btn-large btn-reset" onclick="resetApp()">ğŸ§¹ æ¸…ç©ºé‡ç½®</button>
        </div>
        
        <div id="previewGrid"></div>
    </div>
    <div class="footer">
        Copyright Â© 2026 <a href="https://topmer.top/" target="_blank">Topmer</a>
        | v2.3.0 | ğŸ’¬<a href="https://ly.topmer.top" target="_blank" rel="noopener noreferrer">ç»™æˆ‘ç•™è¨€</a>
    </div>
    
    <script>
        // ========== å¯¼èˆªåŠŸèƒ½ ==========
        function goToHomePage() {
            try {
                const homeUrl = "https://888.topmer.top";
                window.location.href = homeUrl;
            } catch (error) {
                console.error('è¿”å›é¦–é¡µæ—¶å‡ºé”™:', error);
                alert('æ— æ³•è¿”å›é¦–é¡µï¼Œè¯·ç¨åé‡è¯•ï¼');
            }
        }
        
        function openInvoiceTool() {
            try {
                const invoiceUrl = "https://888.topmer.top/fp";
                window.open(invoiceUrl, '_blank', 'noopener,noreferrer');
            } catch (error) {
                console.error('æ‰“å¼€å‘ç¥¨å·¥å…·æ—¶å‡ºé”™:', error);
                alert('æ— æ³•æ‰“å¼€å‘ç¥¨å·¥å…·ï¼Œè¯·ç¨åé‡è¯•ï¼');
            }
        }

        // ========== åº”ç”¨é…ç½® ==========
        const CONFIG = {
            IMAGE_QUALITY: 0.9,
            MARGIN_MM: 4.3,
            SPACING_MM: 4.3,
            TARGET_WIDTH: 1080,
            TARGET_HEIGHT: 2400,
            TARGET_RATIO: 1080 / 2400, // 0.45 (3:4)
            MAX_FILES: 50,
            MM_TO_PX: 96 / 25.4 // 1mm = 3.779527559055118åƒç´ ï¼ˆ96DPIï¼‰
        };

        // ========== åº”ç”¨çŠ¶æ€ ==========
        const AppState = {
            photoFiles: [], // å­˜å‚¨å¤„ç†åçš„æ‰‹æœºæˆªå›¾æ•°æ® {dataUrl, originalName, dimensions}
            originalFileNames: [], // ä¿å­˜åŸå§‹æ–‡ä»¶å
            originalFiles: [], // ä¿å­˜åŸå§‹æ–‡ä»¶å¯¹è±¡
            currentMode: 9, // é»˜è®¤9å¼ æ¨¡å¼
            showCutLines: true, // è£å‰ªçº¿æ˜¾ç¤ºçŠ¶æ€
            isProcessing: false
        };

        const { jsPDF } = window.jspdf;

        // ========== æ ¸å¿ƒè®¡ç®—å‡½æ•° ==========
        function calculateLayout(mode) {
            const A4_WIDTH_MM = 210;
            const A4_HEIGHT_MM = 297;
            const margin = CONFIG.MARGIN_MM;
            const spacing = CONFIG.SPACING_MM;
            
            if (mode === 6) {
                // 1é¡µ6å¼ ï¼šçºµå‘A4ï¼Œ3åˆ—Ã—2è¡Œ
                const columns = 3;
                const rows = 2;
                const contentWidth = A4_WIDTH_MM - (margin * 2);
                const contentHeight = A4_HEIGHT_MM - (margin * 2);
                
                const slotWidth = (contentWidth - (spacing * (columns - 1))) / columns;
                const slotHeight = (contentHeight - (spacing * (rows - 1))) / rows;
                
                if (slotWidth <= 0 || slotHeight <= 0) {
                    throw new Error('è®¡ç®—é”™è¯¯ï¼šæ§½ä½å°ºå¯¸æ— æ•ˆ');
                }
                
                return {
                    columns,
                    rows,
                    photosPerPage: columns * rows,
                    slotWidth,
                    slotHeight,
                    orientation: 'portrait',
                    pageWidth: A4_WIDTH_MM,
                    pageHeight: A4_HEIGHT_MM,
                    margin,
                    spacing
                };
            } else if (mode === 9) {
                // 1é¡µ9å¼ ï¼šçºµå‘A4ï¼Œ3åˆ—Ã—3è¡Œ
                const columns = 3;
                const rows = 3;
                const contentWidth = A4_WIDTH_MM - (margin * 2);
                const contentHeight = A4_HEIGHT_MM - (margin * 2);
                
                const slotWidth = (contentWidth - (spacing * (columns - 1))) / columns;
                const slotHeight = (contentHeight - (spacing * (rows - 1))) / rows;
                
                if (slotWidth <= 0 || slotHeight <= 0) {
                    throw new Error('è®¡ç®—é”™è¯¯ï¼šæ§½ä½å°ºå¯¸æ— æ•ˆ');
                }
                
                return {
                    columns,
                    rows,
                    photosPerPage: columns * rows,
                    slotWidth,
                    slotHeight,
                    orientation: 'portrait',
                    pageWidth: A4_WIDTH_MM,
                    pageHeight: A4_HEIGHT_MM,
                    margin,
                    spacing
                };
            } else {
                // 1é¡µ12å¼ ï¼šæ¨ªå‘A4ï¼Œ6åˆ—Ã—2è¡Œ
                const columns = 6;
                const rows = 2;
                const pageWidth = A4_HEIGHT_MM;
                const pageHeight = A4_WIDTH_MM;
                const contentWidth = pageWidth - (margin * 2);
                const contentHeight = pageHeight - (margin * 2);
                
                const slotWidth = (contentWidth - (spacing * (columns - 1))) / columns;
                const slotHeight = (contentHeight - (spacing * (rows - 1))) / rows;
                
                if (slotWidth <= 0 || slotHeight <= 0) {
                    throw new Error('è®¡ç®—é”™è¯¯ï¼šæ§½ä½å°ºå¯¸æ— æ•ˆ');
                }
                
                return {
                    columns,
                    rows,
                    photosPerPage: columns * rows,
                    slotWidth,
                    slotHeight,
                    orientation: 'landscape',
                    pageWidth,
                    pageHeight,
                    margin,
                    spacing
                };
            }
        }

        // ========== è£å‰ªçº¿åŠŸèƒ½ ==========
        function toggleCutLines() {
            AppState.showCutLines = !AppState.showCutLines;
            const btn = document.getElementById('cutLineToggle');
            
            if (btn) {
                btn.innerText = AppState.showCutLines ? 'å·²å¼€å¯' : 'å·²å…³é—­';
                btn.className = `toggle-btn ${AppState.showCutLines ? 'btn-on' : 'btn-off'}`;
            }
            
            renderPreview();
        }

        // ========== æµè§ˆå™¨å…¼å®¹æ€§æ£€æµ‹ ==========
        function checkBrowserCompatibility() {
            const missingAPIs = [];
            
            if (!window.File) missingAPIs.push('File API');
            if (!window.FileReader) missingAPIs.push('FileReader API');
            if (!window.Promise) missingAPIs.push('Promise API');
            if (!window.HTMLCanvasElement) missingAPIs.push('Canvas API');
            
            if (missingAPIs.length > 0) {
                console.warn('æµè§ˆå™¨ä¸æ”¯æŒä»¥ä¸‹å¿…è¦API:', missingAPIs.join(', '));
                document.getElementById('browserWarning').style.display = 'block';
                return false;
            }
            
            return true;
        }
        
        function closeBrowserWarning() {
            document.getElementById('browserWarning').style.display = 'none';
        }

        // ========== ä½¿ç”¨è¯´æ˜å¼¹çª—åŠŸèƒ½ ==========
        function showHelp() {
            try {
                document.getElementById('helpDialog').style.display = 'flex';
            } catch (error) {
                console.error('æ˜¾ç¤ºå¸®åŠ©å¼¹çª—æ—¶å‡ºé”™:', error);
            }
        }
        
        function closeHelp() {
            try {
                document.getElementById('helpDialog').style.display = 'none';
            } catch (error) {
                console.error('å…³é—­å¸®åŠ©å¼¹çª—æ—¶å‡ºé”™:', error);
            }
        }

        // ========== æ–‡ä»¶åˆ—è¡¨æ›´æ–°å‡½æ•° ==========
        function updateFileList(files) {
            try {
                const fileList = document.getElementById('fileList');
                const fileCount = document.getElementById('fileCount');
                
                if (!fileList || !fileCount) {
                    console.warn('updateFileList: æ–‡ä»¶åˆ—è¡¨å…ƒç´ ä¸å­˜åœ¨');
                    return;
                }
                
                if (!files || files.length === 0) {
                    fileList.innerHTML = '';
                    fileCount.textContent = '0';
                    return;
                }
                
                fileCount.textContent = files.length;
                
                fileList.innerHTML = files.map((file, index) => {
                    const displayName = file.name.length > 25 
                        ? file.name.substring(0, 22) + '...' 
                        : file.name;
                        
                    return `
                        <div class="file-item" title="æ–‡ä»¶å: ${file.name}">
                            <div class="file-name" title="${file.name}">
                                ${index + 1}. ${displayName}
                            </div>
                            <div class="file-status">âœ“ å·²åŠ è½½</div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('æ›´æ–°æ–‡ä»¶åˆ—è¡¨æ—¶å‡ºé”™:', error);
            }
        }

        // ========== å¤„ç†å•å¼ å›¾ç‰‡ ==========
        async function processImageFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const img = new Image();
                    
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        if (!ctx) {
                            reject(new Error('æ— æ³•è·å–canvasä¸Šä¸‹æ–‡'));
                            return;
                        }
                        
                        const currentRatio = img.width / img.height;
                        const targetRatio = CONFIG.TARGET_RATIO;
                        
                        let drawWidth, drawHeight, offsetX = 0, offsetY = 0;
                        
                        if (currentRatio > targetRatio) {
                            drawHeight = CONFIG.TARGET_HEIGHT;
                            drawWidth = drawHeight * currentRatio;
                            offsetX = (drawWidth - CONFIG.TARGET_WIDTH) / 2;
                        } else {
                            drawWidth = CONFIG.TARGET_WIDTH;
                            drawHeight = drawWidth / currentRatio;
                            offsetY = (drawHeight - CONFIG.TARGET_HEIGHT) / 2;
                        }
                        
                        canvas.width = drawWidth;
                        canvas.height = drawHeight;
                        
                        ctx.fillStyle = 'white';
                        ctx.fillRect(0, 0, drawWidth, drawHeight);
                        
                        ctx.drawImage(img, 0, 0, img.width, img.height, 
                                     offsetX, offsetY, CONFIG.TARGET_WIDTH, CONFIG.TARGET_HEIGHT);
                        
                        const imageData = canvas.toDataURL('image/jpeg', CONFIG.IMAGE_QUALITY);
                        
                        resolve({
                            dataUrl: imageData,
                            originalName: file.name,
                            dimensions: {
                                originalWidth: img.width,
                                originalHeight: img.height,
                                processedWidth: drawWidth,
                                processedHeight: drawHeight
                            }
                        });
                        
                        canvas.width = 0;
                        canvas.height = 0;
                    };
                    
                    img.onerror = function() {
                        reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥: ' + file.name));
                    };
                    
                    img.src = e.target.result;
                };
                
                reader.onerror = function() {
                    reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥: ' + file.name));
                };
                
                reader.readAsDataURL(file);
            });
        }

        // ========== å¤„ç†å¤šä¸ªæ–‡ä»¶ ==========
        async function handleFiles(files) {
            if (!files || files.length === 0) {
                console.error('handleFiles: æœªæ¥æ”¶åˆ°æ–‡ä»¶');
                return;
            }

            if (AppState.isProcessing) {
                alert('æ­£åœ¨å¤„ç†æ–‡ä»¶ä¸­ï¼Œè¯·ç¨å€™...');
                return;
            }

            const imageFiles = Array.from(files).filter(f => 
                f.type.startsWith('image/') && 
                ['image/jpeg', 'image/png', 'image/jpg', 'image/webp'].includes(f.type)
            );
            
            if (!imageFiles.length) {
                alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼ˆæ”¯æŒJPGã€PNGã€WEBPæ ¼å¼ï¼‰ï¼');
                return;
            }

            if (imageFiles.length > CONFIG.MAX_FILES) {
                alert(`æœ€å¤šæ”¯æŒ${CONFIG.MAX_FILES}ä¸ªæ–‡ä»¶ï¼Œå·²è‡ªåŠ¨æˆªå–å‰${CONFIG.MAX_FILES}ä¸ª`);
                imageFiles.length = CONFIG.MAX_FILES;
            }

            AppState.isProcessing = true;
            AppState.photoFiles = [];
            AppState.originalFileNames = imageFiles.map(f => f.name);
            AppState.originalFiles = imageFiles;
            
            const progressWrapper = document.getElementById('progressWrapper');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            if (!progressWrapper || !progressBar || !progressText) {
                console.error('è¿›åº¦æ¡å…ƒç´ ä¸å­˜åœ¨');
                AppState.isProcessing = false;
                return;
            }
            
            progressWrapper.style.display = 'block';
            progressBar.style.width = '0%';
            progressText.innerText = `å‡†å¤‡ä¸­...`;

            try {
                for (let i = 0; i < imageFiles.length; i++) {
                    progressText.innerText = `å¤„ç†ä¸­ ${i + 1} / ${imageFiles.length}`;
                    
                    try {
                        const processedImage = await processImageFile(imageFiles[i]);
                        AppState.photoFiles.push(processedImage);
                        
                        const progress = Math.round(((i + 1) / imageFiles.length) * 100);
                        progressBar.style.width = `${progress}%`;
                        
                    } catch (error) {
                        console.error(`æ–‡ä»¶ ${imageFiles[i].name} å¤„ç†å¤±è´¥:`, error);
                        continue;
                    }
                }
                
                const dropZone = document.getElementById('dropZone');
                const feedbackArea = document.getElementById('feedbackArea');
                const successInfo = document.getElementById('successInfo');
                
                if (!dropZone || !feedbackArea || !successInfo) {
                    throw new Error('å¿…è¦çš„DOMå…ƒç´ ä¸å­˜åœ¨');
                }
                
                dropZone.style.display = 'none';
                feedbackArea.style.display = 'flex';
                successInfo.innerText = `âœ… å·²æˆåŠŸåŠ è½½ ${AppState.photoFiles.length} å¼ æ‰‹æœºæˆªå›¾ âœ¨`;
                
                updateFileList(imageFiles);
                
                const exportBtn = document.getElementById('exportBtn');
                const printBtn = document.getElementById('printBtn');
                
                if (exportBtn) exportBtn.disabled = false;
                if (printBtn) printBtn.disabled = false;
                
                renderPreview();
                
            } catch (error) {
                console.error('æ–‡ä»¶å¤„ç†å¤±è´¥:', error);
                alert('æ–‡ä»¶å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•ï¼\né”™è¯¯ä¿¡æ¯: ' + error.message);
                resetApp();
            } finally {
                AppState.isProcessing = false;
                if (progressWrapper) {
                    progressWrapper.style.display = 'none';
                }
            }
        }

        // ========== æ¸²æŸ“é¢„è§ˆ ==========
        function renderPreview() {
            try {
                const grid = document.getElementById('previewGrid');
                if (!grid) {
                    console.error('renderPreview: é¢„è§ˆå®¹å™¨ä¸å­˜åœ¨');
                    return;
                }
                
                grid.innerHTML = '';
                
                if (!AppState.photoFiles.length) return;
                
                const layout = calculateLayout(AppState.currentMode);
                const totalPages = Math.ceil(AppState.photoFiles.length / layout.photosPerPage);
                
                for (let pageIndex = 0; pageIndex < totalPages; pageIndex++) {
                    const pageDiv = document.createElement('div');
                    
                    const pageClass = layout.orientation === 'portrait' ? 'v-page' : 'h-page';
                    pageDiv.className = `preview-page ${pageClass}`;
                    
                    for (let row = 0; row < layout.rows; row++) {
                        for (let col = 0; col < layout.columns; col++) {
                            const slotIndex = row * layout.columns + col;
                            const fileIndex = pageIndex * layout.photosPerPage + slotIndex;
                            
                            if (fileIndex >= AppState.photoFiles.length) continue;
                            
                            const slot = document.createElement('div');
                            slot.className = 'slot';
                            
                            const leftPercent = (layout.margin + (col * (layout.slotWidth + layout.spacing))) / layout.pageWidth * 100;
                            const topPercent = (layout.margin + (row * (layout.slotHeight + layout.spacing))) / layout.pageHeight * 100;
                            const widthPercent = layout.slotWidth / layout.pageWidth * 100;
                            const heightPercent = layout.slotHeight / layout.pageHeight * 100;
                            
                            slot.style.left = `${leftPercent}%`;
                            slot.style.top = `${topPercent}%`;
                            slot.style.width = `${widthPercent}%`;
                            slot.style.height = `${heightPercent}%`;
                            
                            const img = document.createElement('img');
                            img.src = AppState.photoFiles[fileIndex].dataUrl;
                            img.alt = `æ‰‹æœºæˆªå›¾ ${fileIndex + 1} - ${AppState.photoFiles[fileIndex].originalName}`;
                            img.style.background = 'white';

                            if (AppState.currentMode === 9) {
                                img.style.width = '100%';
                                img.style.height = 'auto';
                                img.style.objectFit = 'cover';
                                img.style.objectPosition = 'top center';
                                
                                slot.style.overflow = 'hidden';
                                slot.style.display = 'flex';
                                slot.style.alignItems = 'flex-start';
                                slot.style.justifyContent = 'center';
                                slot.style.background = 'white';
                            } else {
                                img.style.objectFit = 'contain';
                                img.style.width = '100%';
                                img.style.height = '100%';
                            }
                            
                            slot.appendChild(img);
                            pageDiv.appendChild(slot);
                        }
                    }
                    
                    if (AppState.showCutLines) {
                        for (let col = 1; col < layout.columns; col++) {
                            const lineX = layout.margin + (col * layout.slotWidth) + ((col - 0.5) * layout.spacing);
                            const lineXPercent = lineX / layout.pageWidth * 100;
                            
                            const line = document.createElement('div');
                            line.className = 'cut-line vertical';
                            line.style.left = `${lineXPercent}%`;
                            line.style.top = '0%';
                            line.style.height = '100%';
                            
                            pageDiv.appendChild(line);
                        }
                        
                        for (let row = 1; row < layout.rows; row++) {
                            const lineY = layout.margin + (row * layout.slotHeight) + ((row - 0.5) * layout.spacing);
                            const lineYPercent = lineY / layout.pageHeight * 100;
                            
                            const line = document.createElement('div');
                            line.className = 'cut-line horizontal';
                            line.style.top = `${lineYPercent}%`;
                            line.style.left = '0%';
                            line.style.width = '100%';
                            
                            pageDiv.appendChild(line);
                        }
                    }
                    
                    grid.appendChild(pageDiv);
                }
                
                updateModeButtons();
                
            } catch (error) {
                console.error('æ¸²æŸ“é¢„è§ˆæ—¶å‘ç”Ÿé”™è¯¯:', error);
                
                const grid = document.getElementById('previewGrid');
                if (grid) {
                    grid.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #e67e22;">
                            <p>âš ï¸ é¢„è§ˆæ¸²æŸ“å¤±è´¥</p>
                            <p>è¯·å°è¯•è°ƒæ•´è®¾ç½®æˆ–é‡æ–°åŠ è½½æ–‡ä»¶</p>
                            <p>é”™è¯¯ä¿¡æ¯: ${error.message}</p>
                        </div>
                    `;
                }
            }
        }

        // ========== è®¾ç½®æ¨¡å¼ ==========
        function setMode(mode) {
            if (AppState.currentMode === mode) return;
            
            AppState.currentMode = mode;
            
            try {
                const body = document.getElementById('theBody');
                if (body) {
                    body.className = `mode-${mode}`;
                }
                renderPreview();
            } catch (error) {
                console.error('è®¾ç½®æ¨¡å¼æ—¶å‡ºé”™:', error);
            }
        }

        // ========== æ›´æ–°æ¨¡å¼æŒ‰é’® ==========
        function updateModeButtons() {
            try {
                const m6 = document.getElementById('m6');
                const m9 = document.getElementById('m9');
                const m12 = document.getElementById('m12');
                
                if (m6) m6.classList.toggle('active', AppState.currentMode === 6);
                if (m9) m9.classList.toggle('active', AppState.currentMode === 9);
                if (m12) m12.classList.toggle('active', AppState.currentMode === 12);
            } catch (error) {
                console.error('æ›´æ–°æ¨¡å¼æŒ‰é’®æ—¶å‡ºé”™:', error);
            }
        }

        // ========== ä¿å­˜PDF ==========
        async function savePDF() {
            if (!AppState.photoFiles.length) {
                console.warn('savePDF: æ²¡æœ‰å¯å¯¼å‡ºçš„æ–‡ä»¶');
                alert('è¯·å…ˆåŠ è½½æ‰‹æœºæˆªå›¾æ–‡ä»¶ï¼');
                return;
            }
            
            try {
                const layout = calculateLayout(AppState.currentMode);
                
                const doc = new jsPDF({
                    orientation: layout.orientation,
                    unit: 'mm',
                    format: 'a4'
                });
                
                if (!doc) {
                    throw new Error('æ— æ³•åˆ›å»ºPDFæ–‡æ¡£');
                }
                
                const totalPages = Math.ceil(AppState.photoFiles.length / layout.photosPerPage);
                
                for (let pageIndex = 0; pageIndex < totalPages; pageIndex++) {
                    if (pageIndex > 0) {
                        doc.addPage();
                    }
                    
                    for (let row = 0; row < layout.rows; row++) {
                        for (let col = 0; col < layout.columns; col++) {
                            const slotIndex = row * layout.columns + col;
                            const fileIndex = pageIndex * layout.photosPerPage + slotIndex;
                            
                            if (fileIndex >= AppState.photoFiles.length) break;
                            
                            const x = layout.margin + (col * (layout.slotWidth + layout.spacing));
                            const y = layout.margin + (row * (layout.slotHeight + layout.spacing));
                            
                            if (AppState.currentMode === 9) {
                                const dimensions = AppState.photoFiles[fileIndex].dimensions;
                                const imgRatio = dimensions.originalWidth / dimensions.originalHeight;
                                
                                let drawWidth = layout.slotWidth;
                                let drawHeight = layout.slotWidth / imgRatio;
                                
                                if (drawHeight > layout.slotHeight) {
                                    drawHeight = layout.slotHeight;
                                    drawWidth = layout.slotHeight * imgRatio;
                                }
                                
                                const drawY = y;
                                
                                doc.addImage(
                                    AppState.photoFiles[fileIndex].dataUrl,
                                    'JPEG',
                                    x,
                                    drawY,
                                    drawWidth,
                                    drawHeight
                                );
                            } else {
                                doc.addImage(
                                    AppState.photoFiles[fileIndex].dataUrl,
                                    'JPEG',
                                    x,
                                    y,
                                    layout.slotWidth,
                                    layout.slotHeight
                                );
                            }
                        }
                    }
                    
                    if (AppState.showCutLines) {
                        doc.setDrawColor(170, 170, 170);
                        doc.setLineWidth(0.3);
                        doc.setLineDashPattern([3, 3], 0);
                        
                        for (let col = 1; col < layout.columns; col++) {
                            const lineX = layout.margin + (col * layout.slotWidth) + ((col - 0.5) * layout.spacing);
                            doc.line(lineX, layout.margin, lineX, layout.pageHeight - layout.margin);
                        }
                        
                        for (let row = 1; row < layout.rows; row++) {
                            const lineY = layout.margin + (row * layout.slotHeight) + ((row - 0.5) * layout.spacing);
                            doc.line(layout.margin, lineY, layout.pageWidth - layout.margin, lineY);
                        }
                        
                        doc.setLineDashPattern([], 0);
                    }
                }
                
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                doc.save(`æ‰‹æœºæˆªå›¾åˆç‰ˆ_${timestamp}.pdf`);
                
            } catch (error) {
                console.error('å¯¼å‡ºPDFå¤±è´¥:', error);
                
                let errorMsg = 'å¯¼å‡ºPDFå¤±è´¥';
                if (error.message && error.message.includes('security')) {
                    errorMsg += 'ï¼šå¯èƒ½æ˜¯æµè§ˆå™¨å®‰å…¨ç­–ç•¥é™åˆ¶ï¼Œè¯·å°è¯•åœ¨å…¶ä»–æµè§ˆå™¨ä¸­æ“ä½œ';
                } else if (error.message && error.message.includes('memory')) {
                    errorMsg += 'ï¼šæ–‡ä»¶è¿‡å¤§å¯¼è‡´å†…å­˜ä¸è¶³ï¼Œè¯·å‡å°‘æ–‡ä»¶æ•°é‡';
                }
                
                alert(errorMsg + 'ï¼Œè¯·é‡è¯•ï¼');
            }
        }

        // ========== æ‰“å°ç›¸å…³å‡½æ•° ==========
        function showPrintDialog() {
            if (!AppState.photoFiles.length) {
                console.warn('showPrintDialog: æ²¡æœ‰å¯æ‰“å°çš„æ–‡ä»¶');
                alert('è¯·å…ˆåŠ è½½æ‰‹æœºæˆªå›¾æ–‡ä»¶ï¼');
                return;
            }
            
            try {
                let modeText, orientationText;
                
                if (AppState.currentMode === 6) {
                    modeText = '1é¡µ6å¼ (çºµå‘)';
                    orientationText = 'çºµå‘';
                } else if (AppState.currentMode === 9) {
                    modeText = '1é¡µ9å¼ (çºµå‘)';
                    orientationText = 'çºµå‘';
                } else {
                    modeText = '1é¡µ12å¼ (æ¨ªå‘)';
                    orientationText = 'æ¨ªå‘';
                }
                
                const printModeText = document.getElementById('printModeText');
                const printOrientationText = document.getElementById('printOrientationText');
                
                if (printModeText) printModeText.textContent = modeText;
                if (printOrientationText) printOrientationText.textContent = orientationText;
                
                const printDialog = document.getElementById('printDialog');
                if (printDialog) {
                    printDialog.style.display = 'flex';
                }
            } catch (error) {
                console.error('æ˜¾ç¤ºæ‰“å°å¯¹è¯æ¡†æ—¶å‡ºé”™:', error);
            }
        }
        
        function hidePrintDialog() {
            try {
                const printDialog = document.getElementById('printDialog');
                if (printDialog) {
                    printDialog.style.display = 'none';
                }
            } catch (error) {
                console.error('éšè—æ‰“å°å¯¹è¯æ¡†æ—¶å‡ºé”™:', error);
            }
        }
        
        function handlePrint() {
            if (!AppState.photoFiles.length) {
                console.warn('handlePrint: æ²¡æœ‰å¯æ‰“å°çš„æ–‡ä»¶');
                return;
            }
            
            try {
                const body = document.getElementById('theBody');
                if (body) {
                    if (AppState.currentMode === 6 || AppState.currentMode === 9) {
                        body.className = `mode-${AppState.currentMode}`;
                    } else {
                        body.className = 'mode-12';
                    }
                }
                
                setTimeout(() => {
                    window.print();
                    
                    setTimeout(() => {
                        window.scrollTo(0, 0);
                        if (body) {
                            body.className = `mode-${AppState.currentMode}`;
                        }
                    }, 100);
                }, 100);
            } catch (error) {
                console.error('æ‰§è¡Œæ‰“å°æ—¶å‡ºé”™:', error);
                alert('æ‰“å°å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‰“å°æœºè®¾ç½®ï¼');
            }
        }

        // ========== é‡ç½®åº”ç”¨ ==========
        function resetApp() {
            if (AppState.isProcessing) {
                if (!confirm('æ–‡ä»¶æ­£åœ¨å¤„ç†ä¸­ï¼Œç¡®å®šè¦é‡ç½®å—ï¼Ÿ')) {
                    return;
                }
            }
            
            try {
                AppState.photoFiles = [];
                AppState.originalFileNames = [];
                AppState.originalFiles = [];
                AppState.showCutLines = true;
                AppState.isProcessing = false;
                
                const dropZone = document.getElementById('dropZone');
                const feedbackArea = document.getElementById('feedbackArea');
                const previewGrid = document.getElementById('previewGrid');
                const exportBtn = document.getElementById('exportBtn');
                const printBtn = document.getElementById('printBtn');
                const progressWrapper = document.getElementById('progressWrapper');
                const cutLineToggle = document.getElementById('cutLineToggle');
                const fileIn = document.getElementById('fileIn');
                
                if (dropZone) dropZone.style.display = 'flex';
                if (feedbackArea) feedbackArea.style.display = 'none';
                if (previewGrid) previewGrid.innerHTML = '';
                if (exportBtn) exportBtn.disabled = true;
                if (printBtn) printBtn.disabled = true;
                if (progressWrapper) progressWrapper.style.display = 'none';
                if (cutLineToggle) {
                    cutLineToggle.innerText = 'å·²å¼€å¯';
                    cutLineToggle.className = 'toggle-btn btn-on';
                }
                if (fileIn) fileIn.value = '';
                
                setMode(9);
                
                hidePrintDialog();
                
            } catch (error) {
                console.error('é‡ç½®åº”ç”¨æ—¶å‡ºé”™:', error);
                alert('é‡ç½®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼');
            }
        }

        // ========== åˆå§‹åŒ– ==========
        document.addEventListener('DOMContentLoaded', function() {
            try {
                checkBrowserCompatibility();
            } catch (error) {
                console.error('æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§æ—¶å‡ºé”™:', error);
            }
            
            const fileIn = document.getElementById('fileIn');
            if (fileIn) {
                fileIn.addEventListener('change', function(e) {
                    if (e.target && e.target.files) {
                        handleFiles(e.target.files);
                    }
                });
            }
            
            const dropZone = document.getElementById('dropZone');
            if (dropZone) {
                dropZone.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    dropZone.style.background = 'rgba(255, 255, 255, 0.6)';
                    dropZone.style.borderColor = '#147a61';
                });
                
                dropZone.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    dropZone.style.background = 'rgba(255, 255, 255, 0.5)';
                    dropZone.style.borderColor = '#4a6d7c';
                });
                
                dropZone.addEventListener('drop', function(e) {
                    e.preventDefault();
                    dropZone.style.background = 'rgba(255, 255, 255, 0.5)';
                    dropZone.style.borderColor = '#4a6d7c';
                    
                    if (e.dataTransfer && e.dataTransfer.files.length) {
                        handleFiles(e.dataTransfer.files);
                    }
                });
            }
            
            const confirmPrint = document.getElementById('confirmPrint');
            if (confirmPrint) {
                confirmPrint.addEventListener('click', function() {
                    hidePrintDialog();
                    handlePrint();
                });
            }
            
            const cancelPrint = document.getElementById('cancelPrint');
            if (cancelPrint) {
                cancelPrint.addEventListener('click', function() {
                    hidePrintDialog();
                });
            }
            
            const printDialog = document.getElementById('printDialog');
            if (printDialog) {
                printDialog.addEventListener('click', function(e) {
                    if (e.target === this) {
                        hidePrintDialog();
                    }
                });
            }
            
            const helpDialog = document.getElementById('helpDialog');
            if (helpDialog) {
                helpDialog.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeHelp();
                    }
                });
            }
            
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    hidePrintDialog();
                    closeHelp();
                    closeBrowserWarning();
                }
            });
            
            window.addEventListener('error', function(event) {
                console.error('å…¨å±€é”™è¯¯æ•è·:', event.error);
                
                if (event.error && event.error.message) {
                    console.error('é”™è¯¯è¯¦æƒ…:', event.error.message);
                }
            });
            
            window.addEventListener('unhandledrejection', function(event) {
                console.error('æœªå¤„ç†çš„Promiseæ‹’ç»:', event.reason);
                event.preventDefault();
            });
            
            updateModeButtons();
        });
    </script>
</body>
</html>
